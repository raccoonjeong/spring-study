# 3단계. 리액트에서 API 사용하기

## requestAPI 함수 만들기

### 왜 필요한가요?

- requestAPI는 fetch를 감싼 공통 API 호출 함수로, 매번 반복되는 서버 주소, 헤더, 쿠키 설정, JSON 처리 코드를 한 곳에 모아 간단히 재사용할 수 있게 합니다.

- 매번 비슷하게 반복하는 서버 요청을 requestAPI 함수를 사용해서 코드 중복을 줄이고, API 요청 방식을 한 곳에서 통일해 관리할 수 있어 유지보수와 확장이 훨씬 쉬워집니다.

### client/src/api.js

```js
const BASE_URL = "http://localhost:4000"; // 서버 주소

export async function requestAPI(path, { method = "GET", data } = {}) {
  const res = await fetch(`${BASE_URL}${path}`, {
    method,
    headers: { "Content-Type": "application/json" },
    credentials: "include", // 쿠키 사용 (로그인 세션용)
    body: data ? JSON.stringify(data) : undefined,
  });

  if (!res.ok) {
    throw new Error(`HTTP ${res.status}`);
  }

  return res.json(); // 무조건 JSON 응답 가정
}
```

### 사용 예시

#### 글 목록 가져오기 (GET)

```js
const posts = await requestAPI("/posts");
console.log(posts);
```

#### 로그인 (POST)

```js
await requestAPI("/auth/login", {
  method: "POST",
  data: { email: "test@test.com", password: "1234" },
});
```

#### 새 글 작성 (POST)

```js
await requestAPI("/posts", {
  method: "POST",
  data: { title: "새 글", content: "본문 내용", category: "Tech" },
});
```

- JWT 쿠키 로그인 방식에서는 프론트에서 user_id를 보낼 필요가 없음.
- 서버에서 req.user.id를 토큰에서 꺼내서 INSERT 시 user_id 칼럼에 자동으로 기록하게 구현할 수 있음.

## 회원가입 / 로그인 / 로그아웃 예제

### pages/AuthExample.jsx

```jsx
import { useState } from "react";
import { requestAPI } from "../api/requestAPI";

export default function AuthExample() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [nick, setNick] = useState("");
  const [me, setMe] = useState(null);

  async function handleRegister() {
    const user = await requestAPI("/auth/register", {
      method: "POST",
      data: { email, password, nick },
    });
    setMe(user);
  }

  async function handleLogin() {
    const user = await requestAPI("/auth/login", {
      method: "POST",
      data: { email, password },
    });
    setMe(user);
  }

  async function handleLogout() {
    await requestAPI("/auth/logout", { method: "POST" });
    setMe(null);
  }

  async function fetchMe() {
    const user = await requestAPI("/auth/me");
    setMe(user);
  }

  return (
    <div className="p-4 space-y-2">
      <input
        placeholder="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
      />
      <input
        placeholder="password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
      />
      <input
        placeholder="nick (회원가입용)"
        value={nick}
        onChange={(e) => setNick(e.target.value)}
      />

      <div className="space-x-2">
        <button onClick={handleRegister}>회원가입</button>
        <button onClick={handleLogin}>로그인</button>
        <button onClick={handleLogout}>로그아웃</button>
        <button onClick={fetchMe}>내정보 확인</button>
      </div>

      {me && (
        <div>
          현재 로그인: {me.nick} ({me.email})
        </div>
      )}
    </div>
  );
}
```

## 게시글 목록 / 작성 / 수정 / 삭제 예제

### pages/PostsExample.jsx

```jsx
import { useEffect, useState } from "react";
import { requestAPI } from "../api/requestAPI";

export default function PostsExample() {
  const [posts, setPosts] = useState([]);
  const [title, setTitle] = useState("");
  const [category, setCategory] = useState("");
  const [content, setContent] = useState("");

  async function fetchPosts() {
    const res = await requestAPI("/posts");
    setPosts(res.rows);
  }

  async function createPost() {
    await requestAPI("/posts", {
      method: "POST",
      data: { category, title, content },
    });
    fetchPosts();
  }

  async function updatePost(id) {
    await requestAPI(`/posts/${id}`, {
      method: "PUT",
      data: {
        category: "Updated",
        title: "수정된 제목",
        content: "수정된 본문",
      },
    });
    fetchPosts();
  }

  async function deletePost(id) {
    await requestAPI(`/posts/${id}`, { method: "DELETE" });
    fetchPosts();
  }

  useEffect(() => {
    fetchPosts();
  }, []);

  return (
    <div className="p-4">
      <h2>게시글 작성</h2>
      <input
        placeholder="카테고리"
        value={category}
        onChange={(e) => setCategory(e.target.value)}
      />
      <input
        placeholder="제목"
        value={title}
        onChange={(e) => setTitle(e.target.value)}
      />
      <textarea
        placeholder="내용"
        value={content}
        onChange={(e) => setContent(e.target.value)}
      />
      <button onClick={createPost}>작성</button>

      <h2>게시글 목록</h2>
      <ul>
        {posts.map((p) => (
          <li key={p.id}>
            <strong>
              [{p.category}] {p.title}
            </strong>{" "}
            - {p.author_nick}
            <button onClick={() => updatePost(p.id)}>수정</button>
            <button onClick={() => deletePost(p.id)}>삭제</button>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

## 유저 목록 가져오기

### pages/UsersExample.jsx

```jsx
import { useEffect, useState } from "react";
import { requestAPI } from "../api/requestAPI";

export default function UsersExample() {
  const [users, setUsers] = useState([]);

  useEffect(() => {
    requestAPI("/users").then((res) => setUsers(res.rows));
  }, []);

  return (
    <div className="p-4">
      <h2>회원 목록</h2>
      <ul>
        {users.map((u) => (
          <li key={u.id}>
            {u.nick} ({u.email}) - 가입일 {u.created_at}
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### 결론

- React에서는 쿠키를 직접 관리하지 않아도 됨 → credentials: "include"만 있으면 로그인 세션 자동 유지.

- requestAPI로 회원가입/로그인/로그아웃/내정보 확인/글 CRUD/유저 목록까지 다 호출 가능.

## 컴포넌트 위치

```bash
src/pages/AuthExample.jsx

src/pages/PostsExample.jsx

src/pages/UsersExample.jsx

src/pages/Profile.jsx
```

- 홈은 App 안에서 간단히 구성

- useAuth는 src/hooks/useAuth.js에 있고, AuthProvider는 main.jsx에서 감싸준 상태라고 가정합니다.

### Profile.jsx

```jsx
// src/pages/Profile.jsx
import { useAuth } from "../hooks/useAuth";

export default function Profile() {
  const { me, logout } = useAuth();
  return (
    <div className="max-w-md mx-auto p-6 space-y-3">
      <h2 className="text-xl font-bold">Profile</h2>
      <div className="border p-4">
        <div>Email: {me?.email}</div>
        <div>Nick: {me?.nick}</div>
      </div>
      <button className="border px-3 py-1" onClick={logout}>
        로그아웃
      </button>
    </div>
  );
}
```

### App.jsx

```jsx
// src/App.jsx
import { BrowserRouter, Routes, Route, Link, Navigate } from "react-router-dom";
import { useAuth } from "./hooks/useAuth";

import AuthExample from "./pages/AuthExample";
import PostsExample from "./pages/PostsExample";
import UsersExample from "./pages/UsersExample";
import Profile from "./pages/Profile";

// 보호 라우트: 로그인 필요
function ProtectedRoute({ children }) {
  const { me, loading } = useAuth();
  if (loading) return <div className="p-6">로딩 중...</div>;
  if (!me) return <Navigate to="/login" replace />;
  return children;
}

function Nav() {
  const { me } = useAuth();
  return (
    <nav className="border-b">
      <div className="max-w-5xl mx-auto p-4 flex gap-4">
        <Link to="/">Home</Link>
        <Link to="/posts">Posts</Link>
        <Link to="/users">Users</Link>
        {me ? (
          <Link to="/profile">Profile</Link>
        ) : (
          <Link to="/login">Login</Link>
        )}
      </div>
    </nav>
  );
}
function Home() {
  return (
    <div className="max-w-5xl mx-auto p-6 space-y-4">
      <h1 className="text-xl font-bold">react-blog-demo</h1>
      <ul className="list-disc ml-5 space-y-1">
        <li>
          <Link className="underline" to="/login">
            /login
          </Link>{" "}
          — 회원가입/로그인/로그아웃 예제
        </li>
        <li>
          <Link className="underline" to="/posts">
            /posts
          </Link>{" "}
          — 게시글 목록/작성/수정/삭제
        </li>
        <li>
          <Link className="underline" to="/users">
            /users
          </Link>{" "}
          — 사용자 목록
        </li>
        <li>
          <Link className="underline" to="/profile">
            /profile
          </Link>{" "}
          — 로그인 필요
        </li>
      </ul>
      <p className="text-sm text-gray-600">
        이 프로젝트는 requestAPI(fetch 래퍼) + JWT 쿠키 인증을 사용합니다.
      </p>
    </div>
  );
}

export default function App() {
  return (
    <BrowserRouter>
      <Nav />
      <Routes>
        <Route path="/" element={<Home />} />

        {/* 인증 관련 (회원가입/로그인/로그아웃 버튼 포함) */}
        <Route path="/login" element={<AuthExample />} />

        {/* 게시글 CRUD (생성/수정/삭제는 서버가 로그인 필요로 보호) */}
        <Route
          path="/posts"
          element={
            <ProtectedRoute>
              <PostsExample />
            </ProtectedRoute>
          }
        />

        {/* 유저 목록은 공개로 예시 (원하면 ProtectedRoute로 감싸면 됨) */}
        <Route path="/users" element={<UsersExample />} />

        {/* 프로필: 로그인 필요 */}
        <Route
          path="/profile"
          element={
            <ProtectedRoute>
              <Profile />
            </ProtectedRoute>
          }
        />

        {/* 기타 없는 경로 */}
        <Route path="*" element={<Navigate to="/" replace />} />
      </Routes>
    </BrowserRouter>
  );
}
```

## 메모

- 서버는 이미 POST/PUT/DELETE /posts에 대해 로그인(쿠키) 여부를 검사하므로, 라우트를 공개로 둬도 쓰기/수정/삭제는 막힙니다.
