# 3. fetch 함수로 API 통신하기

## 1. fetch 함수란?

fetch는 브라우저에서 제공하는 HTTP 요청 함수입니다.

서버(API)와 통신할 때 사용하며, Promise를 반환합니다.

### 기본 사용법:

```js
fetch("요청할 URL", {
  method: "GET" | "POST" | "PUT" | "PATCH" | "DELETE",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ /_ 보낼 데이터 _/ }),
})
.then((res) => res.json())
.then((data) => console.log(data))
.catch((err) => console.error(err));
```

### 특징

- 기본 메서드는 GET → fetch("url") 만 쓰면 GET 요청.

- 응답(Response) 는 res.json() 으로 JSON 변환해야 데이터 사용 가능.

- 비동기 함수이므로 async/await 과 같이 쓰면 더 깔끔함.

## 1. PostList 만들기

```jsx
import { useEffect, useState } from "react";

function PostList() {
  const [posts, setPosts] = useState([]); // 글 목록 상태
  const [loading, setLoading] = useState(true); // 로딩 상태
  const [error, setError] = useState(null); // 에러 상태

  useEffect(() => {
    const fetchPosts = async () => {
      try {
        const res = await fetch("http://localhost:4000/posts");
        if (!res.ok) {
          throw new Error("서버 응답 오류: " + res.status);
        }
        const data = await res.json();
        setPosts(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchPosts();
  }, []);

  if (loading) return <div>불러오는 중...</div>;
  if (error) return <div>에러: {error}</div>;

  return (
    <div>
      <h1>게시글 목록</h1>
      <ul>
        {posts.map((p) => (
          <li key={p.id}>
            <h3>{p.title}</h3>
            <p>{p.content}</p>
            <small>
              {p.category} | 작성일: {new Date(p.created_at).toLocaleString()}
            </small>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default PostList;
```

## 2. fetch로 값 수정하기

- PUT 요청 → 리소스를 전체 교체

- PATCH 요청 → 리소스의 일부 필드만 수정

### 기본 형태

```js
fetch("http://localhost:4000/posts/1", {
  method: "PUT" | "PATCH",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    title: "새 제목",
    content: "수정된 본문",
    category: "react",
  }),
});
```

## 3. React 예제 (버튼 클릭 시 수정)

```jsx
import { useState } from "react";

function UpdatePost() {
  const [message, setMessage] = useState("");

  const handleUpdate = async () => {
    try {
      const res = await fetch("http://localhost:4000/posts/1", {
        method: "PATCH", // PUT으로 바꿀 수도 있음
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "수정된 제목",
          content: "React에서 수정한 본문",
          // category는 생략 가능 (PATCH니까 부분만 수정)
        }),
      });

      if (!res.ok) {
        throw new Error("서버 응답 오류: " + res.status);
      }

      const data = await res.json();
      setMessage("수정 성공: " + JSON.stringify(data));
    } catch (err) {
      setMessage("에러: " + err.message);
    }
  };

  return (
    <div>
      <button onClick={handleUpdate}>1번 글 수정하기</button>
      <p>{message}</p>
    </div>
  );
}

export default UpdatePost;
```

### 동작 방식

- 버튼 클릭 → handleUpdate 실행.

- fetch로 PATCH /posts/1 호출, JSON 본문 전달.

- 서버에서 해당 글 업데이트 후 수정된 레코드 반환.

- React에서 응답을 화면에 표시.

### 4. PostList에 수정버튼 만들기

PostList(목록 조회)와 UpdatePost(수정 버튼) 컴포넌트를 합쳐서, 각 게시글 옆에 수정 버튼을 눌러서 수정하기

```jsx
import { useEffect, useState } from "react";

function PostList() {
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // 데이터 불러오기
  const fetchPosts = async () => {
    try {
      const res = await fetch("http://localhost:4000/posts");
      if (!res.ok) throw new Error("서버 응답 오류: " + res.status);
      const data = await res.json();
      setPosts(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchPosts();
  }, []);

  // 수정 요청 함수 (PATCH 예제)
  const handleUpdate = async (id) => {
    try {
      const res = await fetch(`http://localhost:4000/posts/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "수정된 제목",
          content: "React에서 수정한 본문",
        }),
      });

      if (!res.ok) throw new Error("수정 실패: " + res.status);

      const updated = await res.json();

      // 수정된 데이터로 상태 갱신
      setPosts((prev) => prev.map((p) => (p.id === id ? updated : p)));
    } catch (err) {
      alert("에러: " + err.message);
    }
  };

  if (loading) return <div>불러오는 중...</div>;
  if (error) return <div>에러: {error}</div>;

  return (
    <div>
      <h1>게시글 목록</h1>
      <ul>
        {posts.map((p) => (
          <li key={p.id} style={{ marginBottom: "1rem" }}>
            <h3>{p.title}</h3>
            <p>{p.content}</p>
            <small>
              {p.category} | 작성일: {new Date(p.created_at).toLocaleString()}
            </small>
            <br />
            <button onClick={() => handleUpdate(p.id)}>
              {p.id}번 글 수정하기
            </button>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default PostList;
```

## 4. fetch로 삭제 요청

### 기본 형태

```js
fetch("http://localhost:4000/posts/1", {
  method: "DELETE",
})
  .then((res) => res.json())
  .then((data) => console.log("삭제 결과:", data))
  .catch((err) => console.error(err));
```

## 5. PostList에 삭제 버튼 만들기

```jsx
import { useEffect, useState } from "react";

function PostList() {
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // 데이터 불러오기
  const fetchPosts = async () => {
    try {
      const res = await fetch("http://localhost:4000/posts");
      if (!res.ok) throw new Error("서버 응답 오류: " + res.status);
      const data = await res.json();
      setPosts(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchPosts();
  }, []);

  // 삭제 요청
  const handleDelete = async (id) => {
    if (!window.confirm(`${id}번 글을 삭제할까요?`)) return;

    try {
      const res = await fetch(`http://localhost:4000/posts/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("삭제 실패: " + res.status);

      const result = await res.json();
      console.log("삭제 완료:", result);

      // 상태에서 해당 글 제거
      setPosts((prev) => prev.filter((p) => p.id !== id));
    } catch (err) {
      alert("에러: " + err.message);
    }
  };

  if (loading) return <div>불러오는 중...</div>;
  if (error) return <div>에러: {error}</div>;

  return (
    <div>
      <h1>게시글 목록</h1>
      <ul>
        {posts.map((p) => (
          <li key={p.id} style={{ marginBottom: "1rem" }}>
            <h3>{p.title}</h3>
            <p>{p.content}</p>
            <small>
              {p.category} | 작성일: {new Date(p.created_at).toLocaleString()}
            </small>
            <br />
            <button onClick={() => handleDelete(p.id)}>
              {p.id}번 글 삭제하기
            </button>
          </li>
        ))}
      </ul>
    </div>
  );
}

export default PostList;
```
